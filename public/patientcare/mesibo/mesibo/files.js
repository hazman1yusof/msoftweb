// files.js

/** Copyright (c) 2021 Mesibo
 * https://mesibo.com
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the terms and condition mentioned
 * on https://mesibo.com as well as following conditions are met:
 *
 * Redistributions of source code must retain the above copyright notice, this
 * list of conditions, the following disclaimer and links to documentation and
 * source code repository.
 *
 * Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 *
 * Neither the name of Mesibo nor the names of its contributors may be used to
 * endorse or promote products derived from this software without specific prior
 * written permission.
 *
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 * Documentation
 * https://mesibo.com/documentation/
 *
 * Source Code Repository
 * https://github.com/mesibo/messenger-javascript
 *
 *
*/

function MesiboFile(s) {
	this.scope = s;
	this.api ={};
	this.init();
}

MesiboFile.prototype.init = function(){
	this.api = this.scope.getMesibo();
}


MesiboFile.prototype.dataURItoBlob = function(dataURI) {
	// convert base64 to raw binary data held in a string
	// doesn't handle URLEncoded DataURIs 
	var byteString = atob(dataURI.split(',')[1]);

	// separate out the mime component
	var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]

	// write the bytes of the string to an ArrayBuffer
	var ab = new ArrayBuffer(byteString.length);

	// create a view into the buffer
	var ia = new Uint8Array(ab);

	// set the bytes of the buffer to the correct values
	for (var i = 0; i < byteString.length; i++) {
		ia[i] = byteString.charCodeAt(i);
	}

	// write the ArrayBuffer to a blob, and you're done
	var blob = new Blob([ab], {
		type: mimeString
	});
	return blob;

}

MesiboFile.prototype.getLinkPreviewJson = async function(pUrl,pPreviewEndpoint, pServiceKey){
	
	if(!isValidString(pUrl))
		return null; 
	
	if(!isValidString(pPreviewEndpoint)){
		MesiboLog("Invalid link preview service");
        return null; 
	}
	
	if(!isValidString(pServiceKey)){
		MesiboLog("Invalid link preview access key");
		return null; 
	}

	//Request to link preview service
    const linkPreviewResponse = await fetch(pPreviewEndpoint+ '?key=' + pServiceKey + '&q=' + pUrl);
    const linkPreviewJson = await linkPreviewResponse.json(); 
	
	if(!isValidString(linkPreviewJson.title))
		MesiboLog("Invalid title in linkPreviewJson");

	if(!isValidString(linkPreviewJson.description))
		MesiboLog("Invalid description in linkPreviewJson");

	if(!isValidString(linkPreviewJson.image)){
		MesiboLog("Invalid image in linkPreviewJson");
		linkPreviewJson.image = LINK_DEFAULT_IMAGE;
	}

	if(!isValidString(linkPreviewJson.url))
		MesiboLog("Invalid url in linkPreviewJson");

	if(isValidString(linkPreviewJson.url))
		linkPreviewJson.hostname = linkPreviewJson.url.replace('http://','').replace('https://','').split(/[/?#]/)[0];

	
	if(linkPreviewJson.error){
		//Fatal error
		MesiboLog("Error in link preview: ", linkPreviewJson.error);
		return null; 
	}
	
	return linkPreviewJson;
}




